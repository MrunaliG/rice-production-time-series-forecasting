---
title: "Rice Production | Time Series Forecasting"
author: "Mrunali Ghelani"
output:
  html_document:
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=F, include=T, collapse=T}
knitr::opts_chunk$set(comment = NA, echo=T, message = FALSE, warning = FALSE)
options("getSymbols.warning4.0"=FALSE)
```


```{r echo=F}
rm(list=ls())
library(tidyverse)
library(tidyr)
library(fpp3)
library(tsibble)
library(magrittr)
library(ggplot2)
```



### {.tabset}

#### Introduction

Agriculture, food, and related industries contribute to 5% of the US Gross Domestic Product (GDP). Rice is one of the 5 major crops produced by the US. 45-50% of the crop is exported each year, and the USA is the 5th largest exporter of rice.

Rice production forecasts help the USDA understand if there will be a surplus or scarcity of rice, and the federal government can accordingly draft agriculture policies and award subsidies to farmers to avoid such a situation. Subsidies typically focus on stabilizing the food chain or ensuring adequate income for farmers. This federal support of specific agricultural crops 
determines their availability and consumption, which in turn impacts the average Americanâ€™s diet and nutrition.

Rice production is analyzed and forecasted in terms of yield, quantity produced, and producer price index. For these 3 time series, we look at:    
    
* What does the future look like for rice production?

* How is the latest trend different from the past?

* What are the implications for our forecast on the agricultural policy and subsidies?


#### Yield

##### Data

Data description:

* Time period: 1960 - 2020
* Time interval: Year
* Total observations: 60
* No missing data

```{r}
rice_yield <- readr::read_csv("FAOSTAT_data_5-3-2022_RICE_YIELD.csv") %>%
  select(Year, Value) %>%
  as_tsibble(index=Year)

rice_yield$Value <- as.numeric(rice_yield$Value)

glimpse(rice_yield)

count_gaps(rice_yield)

rice_yield %>% autoplot() + labs(title = "Rice Yield (1960-2020)", y="Yield (in hg/ha)")
```

##### Train-Test Data Split 

An 80-20 split is used for the training and test data

```{r}
split_id = round(nrow(rice_yield) * 0.8)
split_year = rice_yield[split_id, 1]

rice_yield_train <- rice_yield %>%
  filter(Year <= split_year$Year)

print(paste("Training data observations = ", nrow(rice_yield_train)))

rice_yield_test <- rice_yield %>% 
  filter(Year > split_year$Year)

print(paste("Test data observations = ", nrow(rice_yield_test)))
```


##### Trend

```{r}
rice_yield_train %>% 
  model(STL(Value)) %>%
  components() %>%
  autoplot() + labs(title = "STL Decomposition: Rice Yield", y="Yield (in hg/ha)")
```

* Upward trend
* No seasonality as data is yearly
* Remainder resembles white noise



##### ACF and PACF plots

```{r}
rice_yield_train %>% 
  gg_tsdisplay(Value, plot_type="partial", lag_max=48) + labs(title = "ACF and PACF Plots: Rice Yield", y="Yield (in hg/ha)")

rice_yield_train %>% 
  gg_tsdisplay(difference(Value), plot_type="partial", lag_max=48) + labs(title = "ACF and PACF plots: Rice Yield with Differentiation", y="Yield (in hg/ha)")
```

* PACF plot has a significant spike at lag 1 only
* ACF plot is sinusoidal, and multiple lags are significant
* The differenced series resembles white noise, with the lags largely uncorrelated

Hence, ETS with trend component, MA(1) with lag-1 differencing and auto ARIMA models are evaluated below



##### Model Creation and Training Accuracy

```{r}
fit <- rice_yield_train %>%
  model(ets = ETS(Value),
        arima = ARIMA(Value ~ pdq(0, 1, 1)),
        auto = ARIMA(Value))

fit %>% 
  select(arima) %>%
  report()

fit %>%
  select(auto) %>%
  report()

fit %>% accuracy()
```

Based on the training accuracy, ARIMA(0, 1, 1) is the best model


##### Forecasts and Forecast Accuracy

```{r}
fc <- forecast(fit, h=nrow(rice_yield_test)) 

fc %>% accuracy(rice_yield_test)

fc %>% 
  filter(.model %in% c("arima", "ets")) %>%
  autoplot(rice_yield) + labs(title = "Forecasts: Rice Yield", y="Yield (in hg/ha)")
```

Based on the forecast accuracy and plot, ARIMA(0, 1, 1) is the best model

##### Residual Analysis

```{r}
fit %>% 
  augment() %>% 
  features(.innov, box_pierce, lag = 10, dof = 2)

fit %>% 
  augment() %>% 
  features(.innov, ljung_box, lag = 10, dof = 2)

fit %>% 
  select(arima) %>%
  gg_tsresiduals() + labs(title = "Residual Analysis (ARIMA): Rice Yield")
```

For the ARIMA(0, 1, 1) model, the residuals are uncorrelated, mean-0 centered and do not have a normal distribution. Hence, we can use the point forecasts but the prediction interval forecasts may not be accurate

This confirms that the model is fairly good for forecasting rice yield


##### Five-Year Forecast

```{r}
fit <- rice_yield %>%
  model(arima = ARIMA(Value ~ pdq(0, 1, 1)))

fc <- forecast(fit, h=5) 

fc %>% autoplot(rice_yield) + labs(title = "Five-Year Forecast: Rice Yield", y="Yield (in hg/ha)")

fc
```

Five-Year Point Forecasts:

* 2021: 86,242 hg/ha
* 2022: 87,018 hg/ha
* 2023: 87,794 hg/ha
* 2024: 88,570 hg/ha
* 2025: 89,346 hg/ha

The forecasts follow a continuous upward trend, with year-on-year growth of 1%

#### Production Quantity

##### Data

Data description:

* Time period: 1960 - 2020
* Time interval: Year
* Total observations: 60
* No missing data


```{r}
rice_produced_qty <- readr::read_csv("FAOSTAT_data_5-3-2022_RICE_PROD_QTY.csv") %>%
  select(Year, Value) %>%
  as_tsibble(index=Year)

rice_produced_qty$Value <- as.numeric(rice_produced_qty$Value)

glimpse(rice_produced_qty)

count_gaps(rice_produced_qty)

rice_produced_qty %>% 
  autoplot() + labs(title = "Rice Production Quantity (1960-2020)", y="Quantity (in tonnes)")
```

##### Train-Test data split

An 80-20 split is used for the training and test data

```{r}
split_id = round(nrow(rice_produced_qty) * 0.8)
split_year = rice_produced_qty[split_id, 1]

rice_produced_qty_train <- rice_produced_qty %>%
  filter(Year <= split_year$Year)

print(paste("Training data observations = ", nrow(rice_produced_qty_train)))

rice_produced_qty_test <- rice_produced_qty %>% 
  filter(Year > split_year$Year)

print(paste("Test data observations = ", nrow(rice_produced_qty_test)))
```


##### Trend

```{r}
rice_produced_qty_train %>% 
  model(STL(Value)) %>%
  components() %>%
  autoplot() + labs(title = "STL Decomposition: Rice Production Quantity", y="Quantity (in tonnes)")
```

* Upward trend
* No seasonality as data is yearly
* Remainder resembles white noise



##### ACF and PACF plots

```{r}
rice_produced_qty_train %>%
  gg_tsdisplay(Value, plot_type="partial", lag_max=48) + labs(title = "ACF and PACF Plots: Rice Production Quantity", y="Quantity (in tonnes))")

rice_produced_qty_train %>%
  gg_tsdisplay(difference(Value), plot_type="partial", lag_max=48) + labs(title = "ACF and PACF Plots: Rice Production Quantity with Differentiation", y="Quantity (in tonnes))")
```


* PACF plot has a significant spike at lag 1 only
* ACF plot is sinusoidal, and multiple lags are significant
* The differenced series resembles white noise, with the lags largely uncorrelated (most significant spike for ACF plot at lag-10 and for PACF plot at lag-2)

Hence, ETS with trend component, MA(1) with lag-1 differencing and auto ARIMA models are evaluated below


##### Model Creation and Training Accuracy

```{r}
fit <- rice_produced_qty_train %>%
  model(ets = ETS(Value),
        arima = ARIMA(Value ~ pdq(0, 1, 1)),
        auto = ARIMA(Value))

fit %>% 
  select(arima) %>%
  report()

fit %>%
  select(auto) %>%
  report()

fit %>% accuracy()
```

Based on the training accuracy, ARIMA(2, 1, 0) is the best model


##### Forecasts and Forecast Accuracy

```{r}
fc <- forecast(fit, h=nrow(rice_produced_qty_test))

fc %>% accuracy(rice_produced_qty_test)

fc %>% autoplot(rice_produced_qty) + labs(title = "Forecasts: Rice Production Quantity", y="Quantity (in tonnes)")
```

Based on the forecast accuracy and plot, ARIMA(0, 1, 1) is the best model


##### Residual Analysis

```{r}
fit %>% 
  augment() %>% 
  features(.innov, box_pierce, lag = 10, dof = 2)

fit %>% 
  augment() %>% 
  features(.innov, ljung_box, lag = 10, dof = 2)

fit %>% 
  select(arima) %>%
  gg_tsresiduals() + labs(title = "Residual Analysis (ARIMA): Rice Production Quantity")
```

For the ARIMA(0, 1, 1) model, the residuals resemble white noise based on Box-Pierce test, are largely uncorrelated, close to mean-0 centered and do not have a normal distribution. Hence, we may use the point forecasts but the prediction interval forecasts may not be accurate

This confirms that the model is fairly good for forecasting rice production quantity

##### Five-Year Forecast

```{r}
fit <- rice_produced_qty %>%
  model(arima = ARIMA(Value ~ pdq(0, 1, 1)))

fc <- forecast(fit, h=5) 

fc %>% autoplot(rice_produced_qty) + labs(title = "Five-Year Forecast: Rice Production Quantity", y="Quantity (in tonnes)")

fc
```

Five-Year Point Forecasts:

* 2021: 9,869,139 tonnes
* 2022: 9,985,716 tonnes
* 2023: 10,102,293 tonnes
* 2024: 10,218,870 tonnes
* 2025: 10,335,447 tonnes

The forecasts follow a continuous upward trend, with year-on-year growth of 1%


#### Producer Price Index (YoY)

##### Data

Data description:

* Series ID and link: [WPU01230103](https://fred.stlouisfed.org/series/WPU01230103)
* Time period: 2010 Jan - 2022 Mar
* Time interval: Month
* Total observations: 135
* No missing data
* Month-on-Month % change series resembles a white noise series with mean close to 0 and hence cannot be used for forecasting
* Year-on-Year % change series is used for further analysis

```{r}
rice_ppi <- readr::read_csv("WPU01230103_RICE_PPI.csv") %>%
  mutate('MonthYear' = yearmonth(DATE)) %>%
  rename(Value = WPU01230103) %>%
  select(MonthYear, Value) %>%
  as_tsibble(index=MonthYear) %>%
  filter(MonthYear >= yearmonth("2010 Jan"))
  
rice_ppi$Value <- as.numeric(rice_ppi$Value)

rice_ppi <- rice_ppi %>%
  mutate(MoM = (Value - lag(Value)) / lag(Value) * 100,
    YoY = (Value - lag(Value, 12)) / lag(Value, 12) * 100) 

rice_ppi <- rice_ppi %>% drop_na()

nrow(rice_ppi)
glimpse(rice_ppi)
count_gaps(rice_ppi)

rice_ppi %>% autoplot(Value) + labs(title = "Rice Production Price Index (2010-2022)")

rice_ppi %>% autoplot(MoM) + labs(title = "Rice PPI Month-on-Month % Change", y="% change")

rice_ppi %>% autoplot(YoY) + labs(title = "Rice PPI Year-on-Year % Change", y="% change")
```

##### Train-Test data split

An 80-20 split is used for the training and test data

```{r}
split_id = round(nrow(rice_ppi) * 0.8)
split_yearmonth = rice_ppi[split_id, 1]

rice_ppi_train <- rice_ppi %>%
  filter(MonthYear <= split_yearmonth$MonthYear)

print(paste("Training data observations = ", nrow(rice_ppi_train)))

rice_ppi_test <- rice_ppi %>% 
  filter(MonthYear > split_yearmonth$MonthYear)

print(paste("Test data observations = ", nrow(rice_ppi_test)))
```


##### Seasonality & Trend

```{r}
rice_ppi_train %>% 
  model(STL(YoY)) %>%
  components() %>%
  autoplot() + labs(title = "STL Decomposition: Rice Production Price Index (YoY)", y="% change")

rice_ppi_train %>%
  gg_season(YoY) + labs(y="", title="Seasonal Plot: Rice Production Price Index (YoY)")
```

* No seasonality
* No overall trend (Trend patterns fluctuate with time around mean-0)
* Remainder is mean-0 centered with non-constant variance


##### ACF and PACF plots

```{r}
rice_ppi_train %>% 
  gg_tsdisplay(YoY, plot_type="partial", lag_max=24) + labs(title = "ACF and PACF Plots: Rice Production Price Index (YoY)")
```

* PACF plot has a significant spike at lag 1, with smaller spikes at lags 2, 10, 13
* ACF plot is sinusoidal, and multiple lags are significant

Hence, MA(1)/MA(2) and auto ARIMA models are evaluated below

##### Model Creation and Training Accuracy

```{r}
fit <- rice_ppi_train %>%
  model(arima = ARIMA(YoY ~ pdq(0, 1:13, 1:2) + PDQ(0, 0, 0)),
        auto = ARIMA(YoY))

fit %>% 
  select(arima) %>% 
  report()

fit %>% 
  select(auto) %>% 
  report()

fit %>% accuracy()
```

Based on the training accuracy, ARIMA(1, 0, 2)(2, 0, 0) is the best model


##### Forecasts and Forecast Accuracy


```{r}
fc <- forecast(fit, h=nrow(rice_ppi_test)) 

fc %>% accuracy(rice_ppi_test)

fc %>% autoplot(rice_ppi) + labs(title = "Forecasts: Rice Production Price Index")
```

Based on the forecast accuracy and plot, ARIMA(0, 1, 2) is the better model. However, ARIMA(1, 0, 2)(2, 0, 0) model provides good forecasts as well, with smaller prediction intervals.


##### Residual Analysis

```{r}
fit %>% 
  augment() %>%
  features(.innov, box_pierce, lag = 24, dof = 2)

fit %>% 
  augment() %>%
  features(.innov, ljung_box, lag = 24, dof = 2)

fit %>% 
  select(auto) %>%
  gg_tsresiduals() + labs(title = "Residual Analysis (ARIMA): Rice Production Price Index")
```
 
For the ARIMA(1, 0, 2)(2, 0, 0) model, the residuals resemble white noise, are uncorrelated, mean-0 centered and have a close to normal distribution. Hence, the model suggests that we may use the point forecasts but the prediction interval forecasts may not be reliable

Hence, we use ARIMA(1, 0, 2)(2, 0, 0) model for forecasting.

For better forecasts, it may be advisable to experiment with non-linear models, or conduct sub-sampling analysis (pre-pandemic and post-pandemic time series analysis)

##### 6-Month Forecast

```{r}
fit <- rice_ppi %>%
  model(arima = ARIMA(YoY ~ pdq(1, 0, 2) + PDQ(2, 0, 0)))

fc <- forecast(fit, h=6) 

fc %>% autoplot(rice_ppi) + labs(title = "6-Month Forecast: Rice Producer Price Index (YoY)", y = "% change")

fc
```

Six-Month Point Forecasts:

* 2022 Apr: **21%**
* 2022 May: **20.1%**
* 2022 Jun: **20.6%**
* 2022 Jul: **19.2%**
* 2022 Aug: **16.8%**
* 2022 Sep: **13%**

The model forecasts that the producer price index will continue to increase as compared to the previous year, however, this YoY % change will decrease over time.
It predicts that the highest YoY % change will be seen in April 2022 of **21%**, with predicted PPI as **217.8**

#### Economic Outlook and Policy

Rice yield has increased over the years and we forecast that it will continue to increase. This can be contributed to technological advances in farming methods.

Rice quantity produced has increased over the years but seems to have stagnated now over the past decade. California is a major producer of rice and the on-and-off drought since 2000 has significantly decreased rice production.

Rice producer price index has been volatile over the years with positive YoY change, but the % YoY change is predicted to decline gradually over the next 6 months.

Global demand for rice has been steadily rising and is expected to reach new highs. This opens opportunities for the government to increase rice exports and revenue. There is a growing yield with scope for more rice production. Creating policies, subsidized loans, and financial support that encourage farmers to grow rice and provide ease of exports can help generate revenue.

The government should also look at water conservation and planning policies to lessen the drought-like conditions in California, which is a key producer of rice.
